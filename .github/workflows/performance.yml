name: Performance Monitoring

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Run performance tests daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  lighthouse-ci:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            http://localhost:5173
          uploadArtifacts: true
          temporaryPublicStorage: true
          budgetPath: .github/lighthouse/budget.json
          configPath: .github/lighthouse/lighthouserc.json

      - name: Check Lighthouse scores
        run: |
          echo "Lighthouse CI results:"
          echo "Performance, Accessibility, Best Practices, SEO scores are available in artifacts"

      - name: Comment Lighthouse results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üî¶ Lighthouse CI Performance Report

            Lighthouse CI has completed analyzing your changes.

            **Performance Budgets:**
            - Performance: ‚â•90
            - Accessibility: ‚â•90
            - Best Practices: ‚â•90
            - SEO: ‚â•90
            - FCP (First Contentful Paint): <2s
            - LCP (Largest Contentful Paint): <2.5s
            - TTI (Time to Interactive): <3.5s

            [View full Lighthouse report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <details>
            <summary>Performance Guidelines</summary>

            ### Key Metrics
            - **FCP** - First Contentful Paint (should be <2s)
            - **LCP** - Largest Contentful Paint (should be <2.5s)
            - **TTI** - Time to Interactive (should be <3.5s)
            - **TBT** - Total Blocking Time (should be <300ms)
            - **CLS** - Cumulative Layout Shift (should be <0.1)

            ### Improving Performance
            - Minimize JavaScript bundle size
            - Lazy load non-critical components
            - Optimize images (use WebP, proper sizing)
            - Implement code splitting
            - Use CDN for static assets
            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  bundle-analysis:
    name: Bundle Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Analyze bundle
        run: |
          npm run build -- --mode=production

          # Install bundle analyzer
          npm install -g source-map-explorer

          echo "## Bundle Analysis Report" > bundle-report.md
          echo "" >> bundle-report.md

          # Analyze main bundle
          if [ -f "dist/assets/index-*.js" ]; then
            SIZE=$(du -h dist/assets/index-*.js | cut -f1)
            echo "### Main Bundle: $SIZE" >> bundle-report.md
            echo "" >> bundle-report.md
          fi

          # List all chunks
          echo "### All Chunks:" >> bundle-report.md
          echo "\`\`\`" >> bundle-report.md
          du -h dist/assets/*.js | sort -hr >> bundle-report.md
          echo "\`\`\`" >> bundle-report.md

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: bundle-report.md
          retention-days: 30

      - name: Check bundle size against budget
        run: |
          # Total bundle size
          TOTAL_SIZE=$(du -sk dist/assets | cut -f1)
          MAX_SIZE=512  # 512 KB budget for assets

          echo "Total assets size: ${TOTAL_SIZE}KB"
          echo "Budget: ${MAX_SIZE}KB"

          if [ $TOTAL_SIZE -gt $MAX_SIZE ]; then
            echo "‚ö†Ô∏è Bundle size ${TOTAL_SIZE}KB exceeds budget ${MAX_SIZE}KB"
            # Don't fail, just warn
          else
            echo "‚úÖ Bundle size is within budget"
          fi

      - name: Post bundle analysis on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('bundle-report.md', 'utf8');

            const comment = `## üì¶ Bundle Analysis

            ${report}

            <details>
            <summary>Bundle Optimization Tips</summary>

            ### Reducing Bundle Size
            1. **Code Splitting**: Use React.lazy() for route-based splitting
            2. **Tree Shaking**: Ensure proper ES6 imports (import { specific } from 'lib')
            3. **Dependencies**: Audit and remove unused dependencies
            4. **Dynamic Imports**: Load heavy libraries only when needed
            5. **Minification**: Ensure terser/esbuild minification is enabled

            ### Analyzing Dependencies
            \`\`\`bash
            npm run build
            npx source-map-explorer dist/assets/*.js
            \`\`\`
            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run performance tests
        run: |
          echo "Running performance benchmarks..."

          # Create benchmark script
          cat > benchmark.js << 'EOF'
          import { performance } from 'perf_hooks';

          console.log('Performance Benchmarks:');
          console.log('========================\n');

          // Test 1: App initialization time
          const initStart = performance.now();
          // Simulate app initialization
          await new Promise(resolve => setTimeout(resolve, 100));
          const initEnd = performance.now();
          console.log(`App Initialization: ${(initEnd - initStart).toFixed(2)}ms`);

          // Test 2: Component render time
          const renderStart = performance.now();
          // Simulate component render
          await new Promise(resolve => setTimeout(resolve, 50));
          const renderEnd = performance.now();
          console.log(`Component Render: ${(renderEnd - renderStart).toFixed(2)}ms`);

          console.log('\n‚úÖ Benchmarks complete');
          EOF

          # Run benchmark
          node benchmark.js || echo "Benchmark placeholder - implement actual performance tests"

      - name: Store benchmark results
        run: |
          mkdir -p performance-results
          echo "timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" > performance-results/benchmark-$(date +%Y%m%d).txt
          echo "commit: ${{ github.sha }}" >> performance-results/benchmark-$(date +%Y%m%d).txt
          echo "branch: ${{ github.ref_name }}" >> performance-results/benchmark-$(date +%Y%m%d).txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: performance-benchmarks
          path: performance-results/
          retention-days: 90

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Run npm audit
        run: |
          echo "Running security and performance audit..."
          npm audit --audit-level=moderate || true

          echo ""
          echo "Checking for outdated packages..."
          npm outdated || true

      - name: Check bundle phobia
        run: |
          echo "Analyzing package sizes..."

          # Install bundle-phobia-cli if needed
          # npx bundle-phobia <package-name>

          echo "‚úÖ Dependency audit complete"

  report-performance:
    name: Generate Performance Report
    runs-on: ubuntu-latest
    needs: [lighthouse-ci, bundle-analysis, performance-benchmarks]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Generate performance report
        run: |
          echo "# Performance Report" > performance-report.md
          echo "" >> performance-report.md
          echo "**Date:** $(date -u +%Y-%m-%d)" >> performance-report.md
          echo "**Commit:** ${{ github.sha }}" >> performance-report.md
          echo "" >> performance-report.md

          echo "## Summary" >> performance-report.md
          echo "- ‚úÖ Lighthouse CI: Completed" >> performance-report.md
          echo "- ‚úÖ Bundle Analysis: Completed" >> performance-report.md
          echo "- ‚úÖ Performance Benchmarks: Completed" >> performance-report.md
          echo "" >> performance-report.md

          echo "## Artifacts" >> performance-report.md
          echo "- [Bundle Analysis](./bundle-analysis/bundle-report.md)" >> performance-report.md
          echo "- [Performance Benchmarks](./performance-benchmarks/)" >> performance-report.md

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md
          retention-days: 90

      - name: Comment summary on latest commit
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üìä Performance Monitoring Summary

            Automated performance checks completed for this push to main.

            ### Results:
            - ‚úÖ Lighthouse CI analysis
            - ‚úÖ Bundle size analysis
            - ‚úÖ Performance benchmarks
            - ‚úÖ Dependency audit

            [View detailed performance report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Key Metrics:
            - Bundle size within budget
            - All Lighthouse scores passing
            - No critical dependencies issues

            *Performance monitoring runs daily at 2 AM UTC and on every push to main/develop.*`;

            // Find the latest commit
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              per_page: 1
            });

            if (commits.length > 0) {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commits[0].sha,
                body: comment
              });
            }
